#!/bin/bash

# MothrBox - Unified Encryption + Decentralized Storage System
# Single-image version: exposes only Rust CLI, Deno is internal.

set -e

BLUE='\033[0;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

print_info() { echo -e "${BLUE}ℹ${NC} $1"; }
print_success() { echo -e "${GREEN}✅${NC} $1"; }
print_warning() { echo -e "${YELLOW}⚠${NC} $1"; }
print_error() { echo -e "${RED}❌${NC} $1"; }

IMAGE_NAME="mothrbox-cli"
ENV_DIR="mothrbox_ts"
ENV_FILE="$ENV_DIR/.env"

show_banner() {
    echo -e "${BLUE}"
    cat << 'EOF'
╔════════════════════════════════════════════════════════╗
║                     MOTHRBOX                           ║
║     Encrypted Decentralized Storage System             ║
╚════════════════════════════════════════════════════════╝
EOF
    echo -e "${NC}"
}

# Check prerequisites
check_prerequisites() {
    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed!"
        echo "Install from: https://docs.docker.com/get-docker/"
        exit 1
    fi
}

# Build Docker image if missing
build_image_if_needed() {
    if ! docker images | awk '{print $1":"$2}' | grep -q "^${IMAGE_NAME}:"; then
        print_info "Docker image '${IMAGE_NAME}' not found. Building..."
        docker build -t "${IMAGE_NAME}" .
        print_success "Image '${IMAGE_NAME}' built."
    fi
}

# Interactive .env setup (same as before)
setup_env() {
    print_info "Setting up MothrBox configuration..."
    echo ""

    ENV_TEMPLATE="$ENV_DIR/.env.example"

    if [ ! -d "$ENV_DIR" ]; then
        print_error "Directory '$ENV_DIR' not found."
        exit 1
    fi

    # Handle existing .env
    if [ -f "$ENV_FILE" ]; then
        print_warning ".env file already exists at $ENV_FILE"
        read -p "Overwrite it? (yes/no): " overwrite
        if [ "$overwrite" = "yes" ] || [ "$overwrite" = "y" ]; then
            if [ -f "$ENV_TEMPLATE" ]; then
                cp "$ENV_TEMPLATE" "$ENV_FILE"
                print_success "Overwritten .env from template"
            else
                : > "$ENV_FILE"
                print_success "Created empty .env"
            fi
        else
            print_info "Keeping existing .env"
        fi
    else
        # no .env exists
        if [ -f "$ENV_TEMPLATE" ]; then
            cp "$ENV_TEMPLATE" "$ENV_FILE"
            print_success "Created .env from template"
        else
            : > "$ENV_FILE"
            print_success "Created empty .env"
        fi
    fi

    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "         SELECT SUI NETWORK"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""
    echo "1. Testnet"
    echo "2. Mainnet"
    echo ""
    read -p "Choose network [1-2]: " netchoice

    case "$netchoice" in
        1)
            sed -i 's/^SUI_NETWORK=.*/SUI_NETWORK=testnet/' "$ENV_FILE" 2>/dev/null || echo "SUI_NETWORK=testnet" >> "$ENV_FILE"
            print_success "Set SUI_NETWORK=testnet"
            ;;
        2)
            sed -i 's/^SUI_NETWORK=.*/SUI_NETWORK=mainnet/' "$ENV_FILE" 2>/dev/null || echo "SUI_NETWORK=mainnet" >> "$ENV_FILE"
            print_success "Set SUI_NETWORK=mainnet"
            ;;
        *)
            print_warning "Invalid option, keeping existing SUI_NETWORK."
            ;;
    esac

    echo ""
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo "         ENTER PRIVATE KEY (HIDDEN)"
    echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
    echo ""

    # hidden key input
    read -s -p "Paste your Sui private key (hidden): " sui_key
    echo ""
    read -s -p "Re-enter your Sui private key (confirm): " sui_key_confirm
    echo ""

    if [ "$sui_key" != "$sui_key_confirm" ]; then
        print_error "Private keys do not match."
        exit 1
    fi

    if [[ "$sui_key" != suiprivkey1* ]]; then
        print_error "Invalid key — must start with 'suiprivkey1'"
        exit 1
    fi

    sed -i "s|^SUI_SECRET_KEY=.*|SUI_SECRET_KEY=$sui_key|" "$ENV_FILE" 2>/dev/null || echo "SUI_SECRET_KEY=$sui_key" >> "$ENV_FILE"
    print_success "Private key saved (hidden input)"

    echo ""
    print_success "✔ Configuration complete! $ENV_FILE is ready."
}

# Show help
show_help() {
    echo "USAGE:"
    echo "  ./mothrbox <command> [options]"
    echo ""
    echo "FIRST TIME:"
    echo "  setup              Interactive setup wizard"
    echo "  build              Build docker image"
    echo ""
    echo "SYSTEM (single image):"
    echo "  test               Run local encryption test in docker"
    echo ""
    echo "ENCRYPT:"
    echo "  encrypt <file> <pass>           Encrypt & upload (AES+Walrus)"
    echo "  decrypt <id> <file> <pass>      Download & decrypt (AES+Walrus)"
    echo "  keygen                          Generate ECC keys (local files)"
    echo ""
    echo "LOW LEVEL CLI:"
    echo "  cli [args...]      Run raw mothrbox CLI inside container"
}

# Run mothrbox CLI inside docker
run_cli() {
    build_image_if_needed
    mkdir -p data

    # Ensure .env exists
    if [ ! -f "$ENV_FILE" ]; then
        print_error "Configuration not found! Run: ./mothrbox setup"
        exit 1
    fi

    docker run --rm \
        --dns 8.8.8.8 \
        --dns 1.1.1.1 \
        -v "$PWD/data:/app/data" \
        --env-file "$ENV_FILE" \
        "${IMAGE_NAME}" \
        "$@"
}

# Main script
show_banner
check_prerequisites

if [ $# -eq 0 ]; then
    show_help
    exit 0
fi

COMMAND=$1
shift

case $COMMAND in
    setup)
        setup_env
        ;;
    build)
        build_image_if_needed
        ;;
    test)
        build_image_if_needed
        mkdir -p data
        echo "Test: $(date)" > data/test.txt

        print_info "Testing AES encrypt/decrypt locally via docker..."
        run_cli aes encrypt /app/data/test.txt /app/data/test.enc "TestPass"
        run_cli aes decrypt /app/data/test.enc /app/data/test_dec.txt "TestPass"

        if diff data/test.txt data/test_dec.txt > /dev/null 2>&1; then
            print_success "Encryption/Decryption OK"
            rm -f data/test.txt data/test.enc data/test_dec.txt
        else
            print_error "Encryption/Decryption failed"
            exit 1
        fi
        ;;
    encrypt)
        if [ $# -lt 2 ]; then
            print_error "Usage: ./mothrbox encrypt <file> <password>"
            exit 1
        fi

        FILE=$1
        PASSWORD=$2

        if [ ! -f "$FILE" ]; then
            print_error "File not found: $FILE"
            exit 1
        fi

        mkdir -p data
        BASENAME=$(basename "$FILE")

        # Copy file into ./data if needed
        if [[ "$FILE" != data/* ]]; then
            cp "$FILE" "data/$BASENAME"
            FILE="data/$BASENAME"
        fi

        print_info "Encrypting and uploading via docker..."
        # Inside container we see it as /app/data/<file>
        run_cli walrus upload-aes "/app/$FILE" "$PASSWORD"
        ;;
    decrypt)
        if [ $# -lt 3 ]; then
            print_error "Usage: ./mothrbox decrypt <blobId> <output> <password>"
            exit 1
        fi

        BLOB_ID=$1
        OUTPUT=$2
        PASSWORD=$3

        mkdir -p data

        # If user gave a path not under data, we map to data and copy back
        OUT_BASENAME=$(basename "$OUTPUT")
        OUT_IN_DATA="data/$OUT_BASENAME"

        print_info "Downloading and decrypting via docker..."
        run_cli walrus download-aes "$BLOB_ID" "/app/$OUT_IN_DATA" "$PASSWORD"

        # Copy back if needed
        if [[ "$OUTPUT" != data/* ]]; then
            cp "$OUT_IN_DATA" "$OUTPUT"
        fi

        if [ -f "$OUTPUT" ]; then
            print_success "Saved to: $OUTPUT"
        else
            print_error "Decryption failed"
            exit 1
        fi
        ;;
    keygen)
        mkdir -p data
        print_info "Generating ECC keys via docker..."
        run_cli ecc keygen
        print_success "Keys: data/private.key, data/public.key"
        ;;
    cli)
        # Raw CLI passthrough
        run_cli "$@"
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        print_error "Unknown command: $COMMAND"
        show_help
        exit 1
        ;;
esac
