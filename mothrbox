#!/bin/bash

# MothrBox CLI - Native (No Docker)
# Uses Rust and Deno directly

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
DATA_DIR="$SCRIPT_DIR/data"
RUST_BIN="$SCRIPT_DIR/mothrbox_rs/target/debug/mothrbox_rs"
DENO_CLI="$SCRIPT_DIR/mothrbox_ts/src/walrus-cli.ts"
ENV_FILE="$SCRIPT_DIR/mothrbox_ts/.env"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

print_info() { echo -e "${BLUE}â„¹${NC} $1"; }
print_success() { echo -e "${GREEN}âœ…${NC} $1"; }
print_error() { echo -e "${RED}âŒ${NC} $1"; }

print_header() {
    echo ""
    echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
    echo "â•‘                      MOTHRBOX                          â•‘"
    echo "â•‘        Encrypted Decentralized Storage System         â•‘"
    echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
}

# Ensure data directory exists
mkdir -p "$DATA_DIR"

case "$1" in
    encrypt)
        if [ -z "$2" ] || [ -z "$3" ]; then
            print_error "Usage: ./mothrbox encrypt <file> <password>"
            exit 1
        fi
        
        FILE_PATH="$2"
        PASSWORD="$3"
        
        if [ ! -f "$FILE_PATH" ]; then
            print_error "File not found: $FILE_PATH"
            exit 1
        fi
        
        print_header
        print_info "Encrypting and uploading with AES-256-GCM..."
        
        FILENAME=$(basename "$FILE_PATH")
        ENC_FILE="$DATA_DIR/${FILENAME}.enc"
        
        # Encrypt with Rust
        "$RUST_BIN" aes encrypt "$FILE_PATH" "$ENC_FILE" "$PASSWORD"
        
        # Upload to Walrus
        print_info "ğŸ“¤ Uploading to Walrus..."
        RESULT=$(deno run -A --env-file="$ENV_FILE" "$DENO_CLI" upload "$ENC_FILE")
        
        BLOB_ID=$(echo "$RESULT" | jq -r '.blobId' 2>/dev/null || echo "")
        
        if [ -n "$BLOB_ID" ] && [ "$BLOB_ID" != "null" ]; then
            print_success "Encrypted and uploaded successfully!"
            echo ""
            echo "ğŸ“¦ Encrypted Blob ID: $BLOB_ID"
            echo ""
            print_info "Save this Blob ID and password separately!"
            
            # Cleanup encrypted file
            rm -f "$DATA_DIR/${FILENAME}.enc"
        else
            print_error "Upload failed"
            echo "$RESULT"
            exit 1
        fi
        ;;
    
    decrypt)
        if [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
            print_error "Usage: ./mothrbox decrypt <blob-id> <output-file> <password>"
            exit 1
        fi
        
        BLOB_ID="$2"
        OUTPUT_FILE="$3"
        PASSWORD="$4"
        
        print_header
        print_info "Downloading and decrypting with AES-256-GCM..."
        
        OUTPUT_FILENAME=$(basename "$OUTPUT_FILE")
        ENC_FILE="$DATA_DIR/${OUTPUT_FILENAME}.enc"
        FINAL_OUTPUT="$DATA_DIR/$OUTPUT_FILENAME"
        
        # Download from Walrus
        print_info "ğŸ“¥ Downloading from Walrus..."
        deno run -A --env-file="$ENV_FILE" "$DENO_CLI" download "$BLOB_ID" "$ENC_FILE" > /dev/null
        
        if [ ! -f "$ENC_FILE" ]; then
            print_error "Download failed"
            exit 1
        fi
        
        print_success "Downloaded successfully"
        
        # Decrypt
        "$RUST_BIN" aes decrypt "$ENC_FILE" "$FINAL_OUTPUT" "$PASSWORD"
        
        if [ -f "$FINAL_OUTPUT" ]; then
            print_success "Decrypted successfully"
            print_success "Saved to: data/$OUTPUT_FILENAME"
            rm -f "$ENC_FILE"
        else
            print_error "Decryption failed"
            exit 1
        fi
        ;;
    
    chacha-encrypt)
        if [ -z "$2" ] || [ -z "$3" ]; then
            print_error "Usage: ./mothrbox chacha-encrypt <file> <password>"
            exit 1
        fi
        
        FILE_PATH="$2"
        PASSWORD="$3"
        
        print_header
        print_info "Encrypting and uploading with ChaCha20-Poly1305..."
        
        FILENAME=$(basename "$FILE_PATH")
        ENC_FILE="$DATA_DIR/${FILENAME}.enc"
        
        "$RUST_BIN" chacha encrypt "$FILE_PATH" "$ENC_FILE" "$PASSWORD"
        
        print_info "ğŸ“¤ Uploading to Walrus..."
        RESULT=$(deno run -A --env-file="$ENV_FILE" "$DENO_CLI" upload "$ENC_FILE")
        
        BLOB_ID=$(echo "$RESULT" | grep -oP '"blobId":\s*"\K[^"]+' || echo "")
        
        if [ -n "$BLOB_ID" ]; then
            print_success "Encrypted and uploaded successfully!"
            echo ""
            echo "ğŸ“¦ Encrypted Blob ID: $BLOB_ID"
            rm -f "$ENC_FILE"
        fi
        ;;
    
    chacha-decrypt)
        if [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
            print_error "Usage: ./mothrbox chacha-decrypt <blob-id> <output-file> <password>"
            exit 1
        fi
        
        BLOB_ID="$2"
        OUTPUT_FILE="$3"
        PASSWORD="$4"
        
        print_header
        print_info "Downloading and decrypting with ChaCha20-Poly1305..."
        
        OUTPUT_FILENAME=$(basename "$OUTPUT_FILE")
        ENC_FILE="$DATA_DIR/${OUTPUT_FILENAME}.enc"
        FINAL_OUTPUT="$DATA_DIR/$OUTPUT_FILENAME"
        
        deno run -A --env-file="$ENV_FILE" "$DENO_CLI" download "$BLOB_ID" "$ENC_FILE" > /dev/null
        "$RUST_BIN" chacha decrypt "$ENC_FILE" "$FINAL_OUTPUT" "$PASSWORD"
        
        print_success "Saved to: data/$OUTPUT_FILENAME"
        rm -f "$ENC_FILE"
        ;;
    
    keygen)
        print_header
        print_info "Generating ECC key pair..."
        
        "$RUST_BIN" ecc keygen "$DATA_DIR/private.key" "$DATA_DIR/public.key"
        
        print_success "Keys generated!"
        echo "ğŸ”‘ Private key: data/private.key"
        echo "ğŸ”“ Public key: data/public.key"
        ;;
    
    ecc-encrypt)
        if [ -z "$2" ] || [ -z "$3" ]; then
            print_error "Usage: ./mothrbox ecc-encrypt <file> <public-key>"
            exit 1
        fi
        
        FILE_PATH="$2"
        PUBLIC_KEY="$3"
        
        print_header
        print_info "Encrypting with ECC..."
        
        FILENAME=$(basename "$FILE_PATH")
        ENC_FILE="$DATA_DIR/${FILENAME}.enc"
        
        "$RUST_BIN" ecc encrypt "$FILE_PATH" "$ENC_FILE" "$PUBLIC_KEY"
        
        print_info "ğŸ“¤ Uploading to Walrus..."
        RESULT=$(deno run -A --env-file="$ENV_FILE" "$DENO_CLI" upload "$ENC_FILE")
        
        BLOB_ID=$(echo "$RESULT" | grep -oP '"blobId":\s*"\K[^"]+' || echo "")
        
        if [ -n "$BLOB_ID" ]; then
            print_success "Encrypted and uploaded!"
            echo "ğŸ“¦ Blob ID: $BLOB_ID"
            rm -f "$ENC_FILE"
        fi
        ;;
    
    ecc-decrypt)
        if [ -z "$2" ] || [ -z "$3" ] || [ -z "$4" ]; then
            print_error "Usage: ./mothrbox ecc-decrypt <blob-id> <output-file> <private-key>"
            exit 1
        fi
        
        BLOB_ID="$2"
        OUTPUT_FILE="$3"
        PRIVATE_KEY="$4"
        
        print_header
        print_info "Downloading and decrypting with ECC..."
        
        OUTPUT_FILENAME=$(basename "$OUTPUT_FILE")
        ENC_FILE="$DATA_DIR/${OUTPUT_FILENAME}.enc"
        FINAL_OUTPUT="$DATA_DIR/$OUTPUT_FILENAME"
        
        deno run -A --env-file="$ENV_FILE" "$DENO_CLI" download "$BLOB_ID" "$ENC_FILE" > /dev/null
        "$RUST_BIN" ecc decrypt "$ENC_FILE" "$FINAL_OUTPUT" "$PRIVATE_KEY"
        
        print_success "Saved to: data/$OUTPUT_FILENAME"
        rm -f "$ENC_FILE"
        ;;
    
    status)
        if [ -f "$RUST_BIN" ]; then
            print_success "Rust binary: Ready"
        else
            print_error "Rust binary not built. Run: cd mothrbox_rs && cargo build --release"
        fi
        
        if command -v deno &> /dev/null; then
            print_success "Deno: Ready"
        else
            print_error "Deno not installed"
        fi
        ;;
    
    help|--help|-h|*)
        print_header
        echo "COMMANDS:"
        echo "  encrypt <file> <password>           - Encrypt with AES-256-GCM"
        echo "  decrypt <blob-id> <out> <password>  - Decrypt AES"
        echo "  chacha-encrypt <file> <password>    - Encrypt with ChaCha20"
        echo "  chacha-decrypt <blob-id> <out> <pw> - Decrypt ChaCha20"
        echo "  keygen                              - Generate ECC keys"
        echo "  ecc-encrypt <file> <public-key>     - Encrypt with ECC"
        echo "  ecc-decrypt <blob-id> <out> <key>   - Decrypt with ECC"
        echo "  status                              - Check system status"
        echo "  rebuild                              - Check system status"
        echo ""
        ;;
esac
